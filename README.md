# HSJ – HNSW-based Similarity Join Algorithms

HSJ (HNSW-based Similarity Join) is a family of algorithms designed to efficiently perform **similarity joins over high‑dimensional dense vectors**.  
The methods explore different levels of integration with the **HNSW graph index**, enabling substantial performance improvements while maintaining high recall.

The repository provides three algorithmic variants:

- **HSJ‑Ext** – Executes similarity join *on top of* a standard HNSW index using iterative top‑k expansions.  
- **HSJ‑Ths** – Modifies the HNSW search procedure to support **direct threshold‑based exploration**.  
- **HSJ‑Inc** – An incremental version of HSJ‑Ths that performs **interleaved indexing + searching**, reducing memory and time costs.

---

## Similarity Join

A similarity join takes vector collections and returns all pairs whose similarity exceeds a given threshold.

This operation is fundamental in several tasks:

- near-duplicate detection
- entity resolution
- clustering
- retrieval augmentation
- data deduplication
- multimodal matching
- and others

Traditional similarity join algorithms (e.g., AllPairs, L2AP) rely on inverted indexes and filtering rules that work well for sparse vectors.
However, with the rise of dense embeddings generated by deep learning models, these methods become inefficient due to the lack of sparsity and the high dimensionality.

This motivates the development of new join algorithms optimized specifically for dense vector data — which is the goal of HSJ.

## Citation

If you use HSJ in your work, please cite:

```bash
@inproceedings{HSJ,
 author = {Douglas Santana and Leonardo Ribeiro},
 title = {Approximate Similarity Joins over Dense Vector Embeddings},
 booktitle = {Anais do XXXVIII Simpósio Brasileiro de Bancos de Dados},
 location = {Belo Horizonte/MG},
 year = {2023},
 keywords = {},
 issn = {2763-8979},
 pages = {51--62},
 publisher = {SBC},
 address = {Porto Alegre, RS, Brasil},
 doi = {10.5753/sbbd.2023.232512},
 url = {https://sol.sbc.org.br/index.php/sbbd/article/view/25516}
}
```

---


## Project Structure


- **src/hnswlib/**  
  Contains the modified HNSW implementation used by all HSJ variants.  
  Adds native support for threshold-based retrieval (range search).

- **src/util/**  
  Auxiliary classes

- **src/SimJoin.java**  
  Main executable class that dispatches the algorithm based on input parameters.

- **data/**  
  Input datasets for testing and evaluation.

- **lib/**  
  All required third-party libraries in `.jar` format.

---

## How to Run

### 1. Clone the repository

```bash
git clone https://github.com/douglasrolins/hsj.git
cd hsj
```

### 2. Compile

```bash
javac -cp ".:lib/*" -d bin $(find src -name "*.java")
```

### 3. Run

```bash
java -cp "bin:lib/*" SimJoin plan=hsj-ext fileDir=data/sample/siftsmall_base.fvecs threshold=0.9 runTimes=1
```

---

## Parameters

| Parameter     | Description                                          |
| ------------- | ---------------------------------------------------- |
| `plan`        | HSJ variant to run (`hsj-ext`, `hsj-ths`, `hsj-inc`) |
| `fileDir`     | Path to the dataset file (`csv`, `hdf5`, `fvecs`)    |
| `threshold`   | Similarity threshold (e.g., `0.80`)                  |
| `runTimes`    | Number of repeated executions (for benchmarking)     |
| `printResult` | Whether to print resulting pairs (`true/false`)      |
| `M`           | HNSW `M` parameter (max connections per node)        |
| `ef`         | HNSW search parameter (`efSearch`)                   |
| `efConstruction` | HNSW construction parameter (`efConstruction`)       |
| `datasetHdf5` | dataset in HDF5 data format (train/test) |

---

## Execution Examples

### Basic usage

```bash
java -cp "bin:lib/*" SimJoin plan="hsj-ext" fileDir=data/sample/siftsmall_base.fvecs threshold=0.75 printResult=true > results.txt
```

### Full configuration

```bash
java -cp "bin:lib/*" SimJoin \
    plan="hsj-ths" \
    fileDir=data/siftsmall_base.fvecs \
    threshold=0.85 \
    printResult=true \
    M=32 \
    ef=64 \
    efConstruction=64 > results.txt
```

### With HDF5 format

```bash
java -cp "bin:lib/*" SimJoin plan=hsj-inc fileDir=data/sample/sift-128-euclidean-10k-sample.hdf5 datasetHdf5=train threshold=0.80 runTimes=1
```

---

## Supported Data Formats

HSJ automatically detects the file format based on extension:

| Format   | Description                                         |
| -------- | --------------------------------------------------- |
| `.csv`   | Comma-separated values where each row is a vector   |
| `.hdf5`  | HDF5 file containing datasets such as `"train"`     |
| `.fvecs` | Standard float-vector format                        |


---

## Dependencies

This project requires **Java 17** or higher.
The following external libraries must be available in the `lib/` directory (all provided as JAR files):

- **Apache Commons Lang 3**  
- **Apache Commons Math 3**  
- **Eclipse Collections**
- **JHDF**
- **SLF4J (Simple Logger)**